<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Import - Portfolio Holdings Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .back-link {
            color: white;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 1em;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }
        
        .auth-section {
            text-align: center;
            padding: 40px 20px;
        }
        
        .auth-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
        }
        
        .broker-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .broker-btn {
            background: #f5f5f5;
            border: 2px solid #667eea;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .broker-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .broker-btn.selected {
            background: #667eea;
            color: white;
        }
        
        .broker-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .info-text {
            color: #666;
            margin: 20px 0;
            line-height: 1.6;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 30px;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info .user-icon {
            font-size: 1.5em;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            padding: 6px 15px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fetch-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
            margin-top: 20px;
        }
        
        .fetch-button:hover {
            transform: translateY(-2px);
        }
        
        .fetch-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    {% if user_name %}
    <div class="user-info">
        <span class="user-icon">üë§</span>
        <span>{{ user_name }}</span>
        <button class="logout-btn" onclick="location.href='/logout'">Logout</button>
    </div>
    {% endif %}
    
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Broker Selection</a>
        
        <div class="header">
            <h1>üìß Gmail Auto-Import</h1>
            <p>Automatically fetch portfolio statements from your email</p>
        </div>
        
        <div class="card">
            <div id="authSection" class="auth-section">
                <h2>Connect Your Gmail Account</h2>
                <p class="info-text">
                    Click below to authorize Gmail access. We'll only read emails from your brokers
                    to fetch the latest portfolio statements.
                </p>
                <a href="/gmail/authorize" class="auth-button">
                    üìß Connect Gmail Account
                </a>
            </div>
            
            <div id="fetchSection" style="display: none;">
                <h2>Select Broker to Fetch</h2>
                <p class="info-text">
                    Choose a broker to automatically download the latest portfolio statement from your email.
                </p>
                
                <div class="broker-selection">
                    <div class="broker-btn" onclick="selectBroker('groww')">
                        <div class="broker-icon">üü¢</div>
                        <div>Groww</div>
                    </div>
                    <div class="broker-btn" onclick="selectBroker('zerodha')">
                        <div class="broker-icon">üîµ</div>
                        <div>Zerodha</div>
                    </div>
                    <div class="broker-btn" onclick="selectBroker('angleone')">
                        <div class="broker-icon">üü†</div>
                        <div>AngleOne</div>
                    </div>
                    <div class="broker-btn" onclick="selectBroker('dhan')">
                        <div class="broker-icon">üî∑</div>
                        <div>Dhan</div>
                    </div>
                    <div class="broker-btn" onclick="selectBroker('mstock')">
                        <div class="broker-icon">‚≠ê</div>
                        <div>MSTOCK</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <label for="panInput" style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                        Enter Your PAN Number (Used as PDF password)
                    </label>
                    <input 
                        type="text" 
                        id="panInput" 
                        placeholder="e.g., JYQPK9320A" 
                        style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1em; text-transform: uppercase;"
                        maxlength="10"
                        pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}"
                    />
                    <p style="margin-top: 8px; color: #666; font-size: 0.9em;">
                        Most brokers use your PAN as the password for portfolio statements
                    </p>
                </div>
                
                <button id="fetchButton" class="fetch-button" onclick="fetchFromGmail()" disabled>
                    Fetch Latest Statement
                </button>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Fetching email and extracting holdings...</p>
                </div>
                
                <div id="statusMessage"></div>
                
                <div id="resultsSection" style="display: none; margin-top: 30px;">
                    <h2>Extraction Results</h2>
                    <div id="resultsInfo" style="padding: 20px; background: #f5f5f5; border-radius: 10px; margin-bottom: 20px;"></div>
                    
                    <div style="overflow-x: auto;">
                        <table id="resultsTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden;">
                            <thead style="background: #667eea; color: white;">
                                <tr>
                                    <th style="padding: 15px; text-align: left;">#</th>
                                    <th style="padding: 15px; text-align: left;">ISIN Code</th>
                                    <th style="padding: 15px; text-align: left;">Company Name</th>
                                    <th style="padding: 15px; text-align: right;">Balance</th>
                                    <th style="padding: 15px; text-align: right;">Rate</th>
                                    <th style="padding: 15px; text-align: right;">Value</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody"></tbody>
                        </table>
                    </div>
                    
                    <button id="downloadButton" class="fetch-button" style="margin-top: 20px;">
                        Download as JSON
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let selectedBroker = null;
        
        // Check if already authenticated
        window.onload = function() {
            fetch('/gmail/status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        document.getElementById('authSection').style.display = 'none';
                        document.getElementById('fetchSection').style.display = 'block';
                    }
                })
                .catch(err => console.error('Error checking auth status:', err));
        };
        
        function selectBroker(broker) {
            selectedBroker = broker;
            
            // Update UI
            document.querySelectorAll('.broker-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Enable fetch button
            document.getElementById('fetchButton').disabled = false;
        }
        
        function fetchFromGmail() {
            if (!selectedBroker) {
                showMessage('Please select a broker first', 'error');
                return;
            }
            
            const panNumber = document.getElementById('panInput').value.trim().toUpperCase();
            
            if (!panNumber) {
                showMessage('Please enter your PAN number', 'error');
                return;
            }
            
            // Basic PAN validation
            const panPattern = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
            if (!panPattern.test(panNumber)) {
                showMessage('Invalid PAN format. Should be like: ABCDE1234F', 'error');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('fetchButton').disabled = true;
            document.getElementById('statusMessage').innerHTML = '';
            
            // Fetch from Gmail with PAN
            fetch('/gmail/fetch/' + selectedBroker + '?pan=' + encodeURIComponent(panNumber))
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('fetchButton').disabled = false;
                    
                    if (data.error) {
                        showMessage(data.error, 'error');
                    } else {
                        showMessage(
                            `Successfully fetched and extracted ${data.count} holdings from ${selectedBroker.toUpperCase()}!`, 
                            'success'
                        );
                        
                        // Display results
                        displayResults(data);
                    }
                })
                .catch(err => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('fetchButton').disabled = false;
                    showMessage('Error fetching from Gmail: ' + err.message, 'error');
                });
        }
        
        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }
        
        let currentData = null;
        
        function displayResults(data) {
            currentData = data;
            
            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            
            // Display info
            const infoDiv = document.getElementById('resultsInfo');
            infoDiv.innerHTML = `
                <p><strong>Broker:</strong> ${data.broker.toUpperCase()}</p>
                <p><strong>Email Subject:</strong> ${data.email_subject}</p>
                <p><strong>Date:</strong> ${data.email_date}</p>
                <p><strong>File:</strong> ${data.filename}</p>
                <p><strong>Total Holdings:</strong> ${data.count}</p>
            `;
            
            // Populate table
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            data.holdings.forEach((holding, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #e0e0e0';
                row.innerHTML = `
                    <td style="padding: 12px;">${index + 1}</td>
                    <td style="padding: 12px;"><code>${holding.isin_code}</code></td>
                    <td style="padding: 12px;">${holding.company_name}</td>
                    <td style="padding: 12px; text-align: right;">${holding.current_bal}</td>
                    <td style="padding: 12px; text-align: right;">${holding.rate}</td>
                    <td style="padding: 12px; text-align: right;">${holding.value}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Download JSON
        document.getElementById('downloadButton').addEventListener('click', function() {
            if (!currentData) return;
            
            const dataStr = JSON.stringify(currentData.holdings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${currentData.broker}_portfolio_holdings.json`;
            link.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
