version: '3.8'

services:
  # --- Document Processor (Java/Spring) ---
  am-document-processor:
    container_name: am-document-processor
    build:
      context: ./am-document-processor
      dockerfile: Dockerfile
      args:
        - GITHUB_PACKAGES_USERNAME=${GITHUB_PACKAGES_USERNAME}
        - GITHUB_PACKAGES_TOKEN=${GITHUB_PACKAGES_TOKEN}
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      
      # Database
      - MONGODB_URL=${MONGODB_URL}
      - MONGODB_DATABASE=${MONGODB_DATABASE}
      - MONGODB_USERNAME=${MONGODB_USERNAME}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_AUTHENTICATION_DATABASE=admin
      
      # Kafka
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS}
      - SPRING_KAFKA_CONSUMER_GROUP_ID=${KAFKA_CONSUMER_GROUP_ID}
      - APP_KAFKA_TOPIC_DOCUMENT_UPLOADED=${KAFKA_TOPIC_DOCUMENT_UPLOADED}
      - APP_KAFKA_TOPIC_DOCUMENT_PROCESSED=${KAFKA_TOPIC_DOCUMENT_PROCESSED}

    ports:
      - "8081:8080" # Processor API
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - am-network
    restart: unless-stopped

  # --- Gmail Extractor (Python/Flask) ---
  am-email-extractor:
    container_name: am-email-extractor
    build:
      context: ./am-email-extractor
      dockerfile: Dockerfile
    environment:
      - MONGO_URI=${MONGODB_URL}
      - MONGO_DB=${MONGODB_DATABASE}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS}
    ports:
      - "8082:8080" # Extractor API
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - am-network
    restart: unless-stopped

  # --- Doc Parser Web (Flutter) ---
  am-doc-parser-web:
    container_name: am-doc-parser-web
    build:
      context: ./am-doc-parser-web
      dockerfile: Dockerfile
    ports:
      - "9004:80"
    networks:
      - am-network
    restart: unless-stopped

networks:
  am-network:
    external: true
